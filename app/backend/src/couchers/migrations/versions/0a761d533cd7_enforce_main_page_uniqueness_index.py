"""Enforce main page uniqueness with partial index

Revision ID: 0a761d533cd7
Revises: 93bda1361f40
Create Date: 2021-02-14 19:29:11.774030

"""
import geoalchemy2
import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision = "0a761d533cd7"
down_revision = "93bda1361f40"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index("ix_pages_main_page_for_cluster_id", table_name="pages")
    op.drop_constraint("fk_pages_main_page_for_cluster_id_clusters", "pages", type_="foreignkey")
    op.drop_column("pages", "main_page_for_cluster_id")
    op.create_index(
        "ix_pages_owner_cluster_id_type",
        "pages",
        ["owner_cluster_id", "type"],
        unique=True,
        postgresql_where=sa.text("type = 'main_page'"),
    )
    op.create_check_constraint(
        "ck_pages_main_page_owned_by_cluster",
        "pages",
        "NOT (owner_cluster_id IS NULL AND type = 'main_page')",
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint("ck_pages_main_page_owned_by_cluster")
    op.drop_index("ix_pages_owner_cluster_id_type", table_name="pages")
    op.add_column("pages", sa.Column("main_page_for_cluster_id", sa.BIGINT(), autoincrement=False, nullable=True))
    op.create_foreign_key(
        "fk_pages_main_page_for_cluster_id_clusters", "pages", "clusters", ["main_page_for_cluster_id"], ["id"]
    )
    op.create_index("ix_pages_main_page_for_cluster_id", "pages", ["main_page_for_cluster_id"], unique=True)
    # ### end Alembic commands ###
