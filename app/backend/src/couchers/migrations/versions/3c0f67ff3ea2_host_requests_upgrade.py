"""Host requests upgrade

Revision ID: 3c0f67ff3ea2
Revises: 939e33415d86
Create Date: 2020-09-29 14:41:12.107972

"""
import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = "3c0f67ff3ea2"
down_revision = "939e33415d86"
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table("host_request_events")
    op.drop_constraint("fk_host_requests_conversation_id_conversations", "host_requests", type_="foreignkey")
    op.drop_constraint("fk_host_requests_initial_message_id_messages", "host_requests", type_="foreignkey")
    op.create_foreign_key(op.f("fk_host_requests_id_conversations"), "host_requests", "conversations", ["id"], ["id"])
    op.drop_column("host_requests", "initial_message_id")
    op.drop_column("host_requests", "conversation_id")
    op.add_column(
        "messages",
        sa.Column(
            "host_request_status_target",
            sa.Enum("pending", "accepted", "rejected", "confirmed", "cancelled", name="hostrequeststatus"),
            nullable=True,
        ),
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column("messages", "host_request_status_target")
    op.add_column("host_requests", sa.Column("conversation_id", sa.INTEGER(), autoincrement=False, nullable=False))
    op.add_column("host_requests", sa.Column("initial_message_id", sa.INTEGER(), autoincrement=False, nullable=False))
    op.drop_constraint(op.f("fk_host_requests_id_conversations"), "host_requests", type_="foreignkey")
    op.create_foreign_key(
        "fk_host_requests_initial_message_id_messages", "host_requests", "messages", ["initial_message_id"], ["id"]
    )
    op.create_foreign_key(
        "fk_host_requests_conversation_id_conversations", "host_requests", "conversations", ["conversation_id"], ["id"]
    )
    op.create_table(
        "host_request_events",
        sa.Column("id", sa.INTEGER(), autoincrement=True, nullable=False),
        sa.Column("host_request_id", sa.INTEGER(), autoincrement=False, nullable=True),
        sa.Column("user_id", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "event_type",
            postgresql.ENUM(
                "created",
                "status_change_accepted",
                "status_change_rejected",
                "status_change_confirmed",
                "status_change_cancelled",
                name="hostrequesteventtype",
            ),
            autoincrement=False,
            nullable=False,
        ),
        sa.Column("after_message_id", sa.INTEGER(), autoincrement=False, nullable=False),
        sa.Column(
            "time",
            postgresql.TIMESTAMP(timezone=True),
            server_default=sa.text("now()"),
            autoincrement=False,
            nullable=False,
        ),
        sa.ForeignKeyConstraint(
            ["host_request_id"], ["host_requests.id"], name="fk_host_request_events_host_request_id_host_requests"
        ),
        sa.ForeignKeyConstraint(["user_id"], ["users.id"], name="fk_host_request_events_user_id_users"),
        sa.PrimaryKeyConstraint("id", name="pk_host_request_events"),
    )
    # ### end Alembic commands ###
