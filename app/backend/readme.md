# Couchers.org backend

This is the backend for Couchers.org built in Python. The React web frontend and React Native apps make API calls to it using [gRPC](https://grpc.io/) which are defined via [Protocol Buffers](https://protobuf.dev/). The business logic manipulates a [PostgreSQL](https://www.postgresql.org/) database via [SQLAlchemy](https://www.sqlalchemy.org/). Geospatial features are provided by the [PostGIS extension](https://postgis.net/).

*Readme last updated: 2024/09/11.*

## Quick Start

*These instructions should work directly on Linux and macOS. If you are using Windows, please [install Ubuntu via WSL2](https://documentation.ubuntu.com/wsl/en/latest/guides/install-ubuntu-wsl2/), then follow these instructions inside Ubuntu.*

You need Docker engine installed. Please refer to the [Docker install documentation](https://docs.docker.com/engine/install/) for how to get it.

Next, run the follwoing commands to get up and running:

```sh
## Check out the repo and navigate to
git clone https://github.com/Couchers-org/couchers.git
cd couchers

## Generate the autogenerated API definitions using protobuf and grpc
cd app
docker run --rm -w /app -v $(pwd):/app registry.gitlab.com/couchers/grpc ./generate_protos.sh

## Build and start the docker containers
docker compose up --build
```

This will spin up a complete copy of the database, backend, and proxies needed to run the platform.

This will not currently run the frontend, to do that, please follow the instructions in [app/web/readme.md](../web/readme.md) under *Quick Start*, then *Running against a local backend*.

### Running tests in docker

You can run all tests in docker with the following command, executed in the `app` folder:

```sh
docker-compose -f docker-compose.test.yml up --build
```

### Running tests locally

```sh
## Start the test database
cd app
docker-compose -f docker-compose.test.yml up --no-deps postgres_tests

## Create a virtual environment and enter it, then install the requirements.
cd backend
python3.12 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

## Now run the test
DATABASE_CONNECTION_STRING="postgresql://postgres:06b3890acd2c235c41be0bbfe22f1b386a04bf02eedf8c977486355616be2aa1@localhost:6544/postgres" pytest src/tests/
```

## Q/A:

Q: When running tests python is not connecting to the db. What do I do?

A: Doublecheck that your DB test container is running. Then make sure the DATABASE_CONNECTION_STRING is similar to the one set in `backend.test.env`. Besides `localhost` it should be the same - if it is different the docs may be out of date. Please submit a PR to fix the docs.

Q: I can't connect to the DB!

A: First doublecheck what port the DB is listening on - run `docker-compose up postgres` and it should say something like `listening on IPv6 address "::", port 6545`. Then doublecheck you have the right password. There are TWO passwords - one for the test db and one for the normal db! See app/postgres.dev.env and app/postgres.test.env

[Here is information for debugging the backend inside VS Code](/docs/backend-in-vscode.md)
